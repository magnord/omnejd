var foundPosts = {};
<% for post in @posts do %>
foundPosts['<%=post.id-%>'] = <%=post.to_json-%>.post;
foundPosts['<%=post.id-%>'].rendered = '<%= escape_javascript(render(:partial => 'post', :locals => {:post => post}))-%>';
<% end %>

var newPosts = {};
var oldPosts = {};
for (var i in foundPosts) {
	// If the post is not already present on the page add it to new posts
	if (!currentPosts[foundPosts[i].id]) {
		newPosts[foundPosts[i].id] = foundPosts[i]; 
  }
}
for (var i in currentPosts) {
	post = currentPosts[i];
	// If a post is currently present on the page, but is not in the search results, mark it fordeletion
	if (!foundPosts[post.id]) {
		oldPosts[post.id] = post; 
  }
}
currentPosts = foundPosts;

// Remove old posts
for (var i in oldPosts) {
	post = oldPosts[i];
	$('#post' + post.id).slideUp('slow', function () {$(this).remove()});
	map.removeOverlay(markers[post.id]);
	markers[post.id] = null;
}

// Render new posts
for (var i in newPosts) {
	post = newPosts[i];
	markers[post.id] = new GMarker(new GLatLng(post.pos.y, post.pos.x), { title: post.title });
	map.addOverlay(markers[post.id]);
	$('#posts').append(post.rendered);
}
